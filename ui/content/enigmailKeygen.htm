<html>
<head>
  <title>Enigmail Keygen</title>

  <script language="JavaScript" src="chrome://enigmail/content/enigmailCommon.js">
  </script>

  <script language="JavaScript">

    //netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");

    const NS_PIPECONSOLE_CONTRACTID = "@mozilla.org/process/pipe-console;1"

    var gKeygenConsole = Components.classes[NS_PIPECONSOLE_CONTRACTID].createInstance(Components.interfaces.nsIPipeConsole);

    WRITE_LOG("enigmailKeygen.htm: gKeygenConsole = "+gKeygenConsole+"\n");

    gKeygenConsole.open(100, 80);

    function terminateFunc() {
        EnigAlert("Key generation completed!");
    }

    var requestObserver = new RequestObserver(terminateFunc, null);
    gKeygenConsole.observe(requestObserver, null);

    var passphrase = null;

    passphrase = EnigPassphrase();

    var gKeygenProcess;
    try {
       gKeygenProcess = gEnigmailSvc.generateKey("First M. Last",
                                                 "comment",
                                                 "user@example.com",
                                                 0,
                                                 passphrase,
                                                 gKeygenConsole);
    } catch (ex) {
    }

    if (!gKeygenProcess) {
       EnigAlert("Key generation failed!");
    }

    dump("enigmailKeygen.htm: gKeygenProcess = "+gKeygenProcess+"\n");

    window.mouseDownState = false;

    function RefreshConsole() {

      //dump("enigmailKeygen.htm: RefreshConsole\n");
      if (gKeygenConsole && gKeygenConsole.hasNewData) {

       gKeygenConsole.hasNewData = true;
       var console = document.getElementById('console');
       console.firstChild.data = gKeygenConsole.data;

       if (!window.mouseDownState)
          window.scrollTo(0,9999);
      }

      if (!gKeygenProcess.isAttached) {
        dump("enigmailKeygen.htm: KeygenProcess terminated\n");
        UnloadHandler();

        var exitCode = gKeygenProcess.exitCode();
        dump("enigmailKeygen.htm: exitCode = "+exitCode+"\n");
        
        gKeygenProcess.terminate();
        gKeygenProcess = null;
        gEnigmailSvc.keygenProcess = null;

        gKeygenConsole.close();
        gKeygenConsole = null;
        gEnigmailSvc.keygenConsole = null;

        // Give focus to this window
        window.focus();
      }

      return false;
    }

    function LoadHandler() {
      // Refresh console every second
      if (gEnigmailSvc)
         window.consoleIntervalId = window.setInterval(RefreshConsole, 1000);
    }

    function UnloadHandler() {
       // Cancel console refresh
       if (window.consoleIntervalId)
          window.clearInterval(window.consoleIntervalId);
    }

    function MouseDown(val) {
      // Tracks mouse down state
      window.mouseDownState = val;
      return true;
    }

  </script>

</head>

<body onLoad="LoadHandler();"
      onMouseDown="MouseDown(true);"
      onMouseUp="MouseDown(false);"
      onUnload="UnloadHandler();">

  <pre id="console">
   KEYGEN
  </pre>

</body>

</html>
